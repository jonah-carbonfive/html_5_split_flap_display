<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>HTML5 boilerplate—all you really need…</title>
	<style type="text/css">
		#display {
			background-color: black;
		}
		#caches {
			background-color: black;
			display: block;
		}
	</style>
	<!--[if IE]>
		<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<script type="text/javascript" charset="utf-8">
	var SYMBOL_SET = ['A', 'B', 'C', 'D', 'E', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z'];
	var FLAP_PADDING = {'x': 5, 'y': 50};
	
	var tester;
	
	function el(id) { return document.getElementById(id); }
	function each(a,f) { for (var i=0,l=a.length; i<l; i++) f(a[i],i); }
	
	function init() {
		var canvas = el('display');
		var context = canvas.getContext('2d')
		
		var font = "bold 36px Monospace";
		context.font = font;
		
		var cache_container = el('caches');
		
		var symbol_bounds = {'width': 0, 'height': 24};
		var symbol;
		for(symbol in SYMBOL_SET) {
			symbol_bounds['width'] = Math.max(symbol_bounds['width'], context.measureText(SYMBOL_SET[symbol]).width);
		}
		
		var symbol_set = new SymbolSet(SYMBOL_SET, symbol_bounds, font, cache_container);
		split_flap = new SplitFlap(symbol_set, context, {'x':100, 'y':100, 'width':26, 'height':40});
		split_flap.draw();
		
		split_flap = new SplitFlap(symbol_set, context, {'x':100, 'y':200, 'width':26, 'height':40});
		split_flap.current_symbol_index = 1;
		split_flap.draw();
		split_flap.flipToSymbolIndex(15);
		split_flap.draw();
		
		tester = split_flap;
		
		drawLoop();
	}
	function drawLoop() {
		setTimeout(function() {console.log('frame'); drawLoop()}, 30);
	}
	
	function SymbolSet(symbols, bounds, font, container) {
		this.symbols = symbols;
		this.bounds = bounds;
		
		this.symbols_canvas = document.createElement('canvas');
	    this.symbols_canvas.setAttribute('width', symbols.length * bounds['width']); 
		this.symbols_canvas.setAttribute('height', bounds['height']);
		container.appendChild(this.symbols_canvas);
		var context = this.symbols_canvas.getContext('2d');
		
		context.fillStyle = 'white';
		context.strokeStyle = 'white';
		context.font = font;
		context.textAligh = "center";
		var x = 0;
		var y = bounds['height'];
		var symbol;
		for(symbol in this.symbols) {
			context.fillText(this.symbols[symbol], x, y);
			x += bounds['width'];
		}
	}
	SymbolSet.prototype.drawSymbol = function(symbol_index, context, display_width, display_height) {
		context.save();

		//crop the symbol from the cache canvas
		var sx = this.bounds['width'] * symbol_index;
		var sy = 0;
		var sw = this.bounds['width'];
		var sh = this.bounds['height'];

		//center symbol in the display area
		context.textBaseline = "top";
		var dx = (display_width - sw)/2;
		var dy = (display_height - sh)/2;
		var dw = sw;
		var dh = sh;

		context.drawImage(this.symbols_canvas, sx, sy, sw, sh, dx, dy, dw, dh);
		context.restore();
	}
	
	function SplitFlap(symbol_set, context, bounds) {
		this.symbol_set = symbol_set;
		this.current_symbol_index = 0;
		this.goal_symbol_index = 0;
		this.context = context;
		this.bounds = bounds;
		this.animating = 100;
	}
	SplitFlap.prototype.draw = function() {
		this.context.save();
		this.context.fillStyle = 'white';
		this.context.strokeStyle = 'white';
		this.context.transform(1,0, 0,1, this.bounds['x'],this.bounds['y']);
		this.drawTopFlap();
		this.context.transform(1,0, 0,1, 0,this.bounds['height']/2);
		this.drawBottomFlap();
		this.context.restore();
	}
	SplitFlap.prototype.drawTopFlap = function() {
		this.context.save();
		this.context.clearRect(0, 0, this.bounds['width'], this.bounds['height']/2);
		this.context.beginPath();
		this.context.moveTo(0, 0);
		this.context.lineTo(this.bounds['width'], 0);
		this.context.lineTo(this.bounds['width'], this.bounds['height']/2);
		this.context.lineTo(0, this.bounds['height']/2);
		this.context.lineTo(0, 0);
		this.context.stroke();
		// this.context.clip();
		if (this.animating() == false) {
			this.context.transform(1,0, 0,1, 0,this.bounds['height'] / 4);
			this.drawSymbol();
		}
		this.context.restore();
	}
	SplitFlap.prototype.drawBottomFlap = function() {
		this.context.save();
		this.context.clearRect(0, 0, this.bounds['width'], this.bounds['height']/2);
		this.context.beginPath();
		this.context.transform(1,0, 0,1, 30,0);
		this.context.moveTo(0, 0);
		this.context.lineTo(this.bounds['width'], 0);
		this.context.lineTo(this.bounds['width'], this.bounds['height']/2);
		this.context.lineTo(0, this.bounds['height']/2);
		this.context.lineTo(0, 0);
		this.context.stroke();
		// this.context.clip();
		this.context.transform(1,0, 0,1, 0,-this.bounds['height'] / 4);
		this.drawSymbol();
		this.context.restore();
	}
	SplitFlap.prototype.drawSymbol = function() {
		this.symbol_set.drawSymbol(this.current_symbol_index, this.context, this.bounds['width'], this.bounds['height']/2);
	}
	SplitFlap.prototype.jumpToSymbolIndex = function(symbol_index) {
		this.current_symbol_index = symbol_index;
		this.goal_symbol_index = symbol_index;
		this.animation_progress = 100;
		this.tick();
	}
	SplitFlap.prototype.flipToSymbolIndex = function(symbol_index) {
		this.goal_symbol_index = symbol_index;
		this.animation_progress = 0;
		this.tick();
	}
	SplitFlap.prototype.tick = function() {
		if (this.current_symbol_index != this.goal_symbol_index) {
			this.animating = !this.animating;
			this.draw();
		}
	}
	SplitFlap.animating = function() {
		return this.animation_progress < 100;
	}
	</script>
</head>

<body onload="init()">
	<canvas id="display" width="1000" height="650"></canvas>
	<div id="caches"></div>
	<div id="credits">
		<a href="#"></a>
	</div>
</body>

</html>